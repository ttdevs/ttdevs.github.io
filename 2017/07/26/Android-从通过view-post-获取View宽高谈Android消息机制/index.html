<!DOCTYPE html>
          <head>
        <meta charset="utf-8">
            
            <title>
                [Android]ä»é€šè¿‡view.post()è·å–Viewå®½é«˜è°ˆAndroidæ¶ˆæ¯æœºåˆ¶ | ttdevs
            </title>
            <meta content="width=device-width, initial-scale=1" name="viewport">
            <meta name="theme-color" content="#4184f3">
            
            
            <link href="/favicon.ico" rel="icon"/>
            

            <link rel="stylesheet" href="/css/highlight.light.css">
            <link rel="stylesheet" href="/css/prism-customize.css">
            <link rel="stylesheet" href="/css/nav-icon.css">
            <link rel="stylesheet" href="/css/waves.min.css">
            <link rel="stylesheet" href="/css/jquery.tocify.css">
            <link rel="stylesheet" href="/css/main.css">
            <link rel="stylesheet" href="/css/nav-indicator.css">
            
  

  
  <!-- è°·æ­Œç»Ÿè®¡ -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-97465173-1', 'auto');
    ga('send', 'pageview');

  </script>
  
            </meta>
        </meta>
    </head>

    <body>
        <header>
            <!-- cover image or sth. -->
        </header>
        <div id="main" class="m-scene">
            
<div class="nav-wrapper">

    <div class="container">
        <nav>
            <div class="logo wave">
                <a href="/" id="logo">
                    ttdevs
                </a>
            </div>
            <div class="nav-toggle-icon" >
                <div class="material-hamburger">
                    <span>
                    </span>
                    <span>
                    </span>
                    <span>
                    </span>
                </div>
            </div>
            <div class="menu-wrapper">
                <div class="nav-indicator">
                </div>
                <ul class="menus">
                    
                     
                        <li>
                            <a class="wave " href="/">
                                é¦–é¡µ
                            </a>
                        </li>
                     
                        <li>
                            <a class="wave " href="/archives">
                                å½’æ¡£
                            </a>
                        </li>
                     
                        <li>
                            <a class="wave " href="/about">
                                å…³äº
                            </a>
                        </li>
                     
                    
                   
                </ul>
            </div>
        </nav>
    </div>
</div>
            <div class="container content">
                <div class="scene_element scene_element--fadein">
                    <div class="row">
    <div class="main">
        <article>
          
          <header class="post-header with-cover" style="background-image:url('/2017/07/26/Android-ä»é€šè¿‡view-post-è·å–Viewå®½é«˜è°ˆAndroidæ¶ˆæ¯æœºåˆ¶/cover.jpg')" >
          
          </header>
          <h1 class="post-title">[Android]ä»é€šè¿‡view.post()è·å–Viewå®½é«˜è°ˆAndroidæ¶ˆæ¯æœºåˆ¶</h1>

          <section class="post-info">
            <span class="post-date">2017/07/26</span>
            
            <span class="post-category">
                <a class="article-category-link" href="/categories/æŠ€æœ¯/">æŠ€æœ¯</a>
            </span>
            
            
            <span class="post-tags">
              <ul class="post-tag-list"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/Android/">Android</a></li></ul>
            </span>
            
          </section>

          <section class="post-content">
            <h2 id="0x00-é€šè¿‡view-post-è·å–Viewå®½é«˜"><a href="/2017/07/26/Android-ä»é€šè¿‡view-post-è·å–Viewå®½é«˜è°ˆAndroidæ¶ˆæ¯æœºåˆ¶/#0x00-é€šè¿‡view-post-è·å–Viewå®½é«˜" class="headerlink" title="0x00 é€šè¿‡view.post()è·å–Viewå®½é«˜"></a>0x00 é€šè¿‡view.post()è·å–Viewå®½é«˜</h2><p>æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›åœ¨ç•Œé¢åˆå§‹è¯çš„æ—¶å€™æ ¹æ®Viewçš„å°ºå¯¸æ¥åšä¸€äº›ç›¸å…³çš„æ“ä½œï¼ˆè°ƒæ•´ï¼‰ï¼Œé‚£å¦‚ä½•è·å–Viewçš„å°ºå¯¸å‘¢ï¼Ÿ</p>
<ul>
<li><p>åœ¨Activityçš„ <code>onCreate()</code> æ–¹æ³•ä¸­ delay å‡ ç™¾æ¯«ç§’<br><br>  ç”±äºæˆ‘ä»¬çŸ¥é“åœ¨ <code>onCreate()</code> ä¸­ç›´æ¥è·å–Viewçš„å°ºå¯¸å¾—åˆ°çš„å®½é«˜éƒ½æ˜¯0ï¼Œè¿™ä¸ªä¸ç»æ€è€ƒçš„ç­”æ¡ˆç›¸ä¿¡å¾ˆå¤šäººåœ¨ç”¨ã€‚</p>
</li>
<li><p>å¦‚æœä½ Googleè¿‡ç­”æ¡ˆï¼Œä¸€èˆ¬ä¼šæœ‰ä¸‹é¢è¿™å‡ ç§æ–¹æ³•ï¼š</p>
<ul>
<li><p>onWindowFocusChanged</p>
<p>  é‡å†™Activityçš„ <code>onWindowFocusChanged()</code> æ–¹æ³•ï¼Œå½“Activityçš„ç„¦ç‚¹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ä¼šå›è°ƒè¿™ä¸ªæ–¹æ³•ï¼Œå‚æ•° <code>hasFocus</code> ä¸º <code>true</code> æ—¶è¡¨ç¤ºå·²ç»è·å–åˆ°ç„¦ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™Viewçš„ç»˜åˆ¶å·²ç»å®Œæˆï¼Œä¹Ÿå°±å¯ä»¥è·å–åˆ°Viewçš„å°ºå¯¸äº†ã€‚</p>
<pre><code>@Override
public void onWindowFocusChanged(boolean hasFocus) {
  super.onWindowFocusChanged(hasFocus);
  if (hasFocus) {
      System.out.println(&quot;&gt;&gt;&gt;&gt;&gt;onWindowFocusChanged&quot; + tvLog.getWidth());
      System.out.println(&quot;&gt;&gt;&gt;&gt;&gt;onWindowFocusChanged&quot; + tvLog.getHeight());
  }
}
</code></pre></li>
<li><p>ViewTreeObserver.addOnPreDrawListener or .addOnGlobalLayoutListener</p>
<p>  è¿™ä¸ªæ–¹æ³•çš„ç¼ºç‚¹æ˜¯ä¼šå¤šæ¬¡è°ƒç”¨ã€‚</p>
<pre><code>private void getViewSize(){
    tvLog.getViewTreeObserver().addOnPreDrawListener(new ViewTreeObserver.OnPreDrawListener() {
        @Override
        public boolean onPreDraw() {
            System.out.println(&quot;&gt;&gt;&gt;&gt;&gt;addOnPreDrawListener&quot; + tvLog.getWidth());
            System.out.println(&quot;&gt;&gt;&gt;&gt;&gt;addOnPreDrawListener&quot; + tvLog.getHeight());
            return true;
        }
    });
    tvLog.getViewTreeObserver().addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener() {
        @Override
        public void onGlobalLayout() {
            System.out.println(&quot;&gt;&gt;&gt;&gt;&gt;addOnGlobalLayoutListener&quot; + tvLog.getWidth());
            System.out.println(&quot;&gt;&gt;&gt;&gt;&gt;addOnGlobalLayoutListener&quot; + tvLog.getHeight());
        }
    });
}
</code></pre></li>
<li><p>view.post()</p>
<p>  è¿™ä¸­æ–¹æ³•æ˜¯æˆ‘ä¸ªäººæ¨èçš„æ–¹æ³•ï¼Œæ¥ä¸‹æ¥çš„å†…å®¹ä¼šç€é‡åˆ†æã€‚</p>
<pre><code>private void getViewSize() {
    tvLog.post(new Runnable() {
        @Override
        public void run() {
            System.out.println(&quot;&gt;&gt;&gt;&gt;&gt;post&quot; + tvLog.getWidth());
            System.out.println(&quot;&gt;&gt;&gt;&gt;&gt;post&quot; + tvLog.getHeight());
        }
    });
}
</code></pre></li>
<li><p>å½“ç„¶ï¼Œè¿˜ä¼šæœ‰ä¸€äº›å…¶ä»–æ–¹æ³•ï¼Œæ¯”å¦‚æ‰‹åŠ¨measureï¼Œåœ¨Viewå†…éƒ¨è·å–ç­‰ç­‰</p>
</li>
</ul>
</li>
</ul>
<p><a href="https://stackoverflow.com/questions/3591784/getwidth-and-getheight-of-view-returns-0" target="_blank" rel="external">å¯ä»¥å‚è€ƒè¿™é‡Œ</a></p>
<p>ä»¥ä¸Šçš„å‡ ç§æ–¹æ³•éƒ½å¯ä»¥ï¼Œä¸‹é¢é’ˆå¯¹View.poståšä¸€ä¸ªåˆ†æã€‚</p>
<h2 id="0x01-Androidç³»ç»Ÿçš„æ¶ˆæ¯æœºåˆ¶"><a href="/2017/07/26/Android-ä»é€šè¿‡view-post-è·å–Viewå®½é«˜è°ˆAndroidæ¶ˆæ¯æœºåˆ¶/#0x01-Androidç³»ç»Ÿçš„æ¶ˆæ¯æœºåˆ¶" class="headerlink" title="0x01 Androidç³»ç»Ÿçš„æ¶ˆæ¯æœºåˆ¶"></a>0x01 Androidç³»ç»Ÿçš„æ¶ˆæ¯æœºåˆ¶</h2><p>Androidç³»ç»Ÿçš„æ¶ˆæ¯æœºåˆ¶ï¼Œæ˜¯æ¯ä¸ªåˆå­¦è€…éƒ½å¿…é¡»æŒæ¡çš„åŸºç¡€çŸ¥è¯†ã€‚ä»¥å‰å­¦ä¹ çš„æ—¶å€™æœ‰çœ‹è¿‡ï¼Œåˆé¢è¯•çš„æ—¶å€™ä¹Ÿå»çªå‡»è¿‡ï¼Œä½†æ˜¯éƒ½æ·±å…¥çš„å»ç†è§£å»æŒæ¡ï¼Œæƒ­æ„§å‘¢ã€‚</p>
<p>å¯¹äºä¸€ä¸ªæ¶ˆæ¯ç³»ç»Ÿï¼Œå¤§å®¶å¯ä»¥ç±»æ¯”ä¸‹ç”Ÿæ´»ä¸­çš„å¿«é€’ç³»ç»Ÿï¼šæœ‰å‘ä»¶äººï¼Œæœ‰æ”¶ä»¶äººï¼Œæœ‰å¿«é€’å…¬å¸ï¼Œå½“ç„¶è¿˜æœ‰æœ€é‡è¦çš„ä¿¡ä»¶ã€‚é€šè¿‡è¿™ä¸ªç³»ç»Ÿæˆ‘ä»¬å¯ä»¥å°†ä¸åŒçš„ä¿¡ä»¶æŠ•é€åˆ°ä¸åŒçš„åœ°æ–¹ï¼Œæ¯”å¦‚ä»ä¸ªäººæŠ•é€åˆ°æ”¿åºœéƒ¨é—¨ï¼Œä»å›½å†…æŠ•é€åˆ°å›½å¤–ç­‰ã€‚ä¸‹é¢çš„è¡¨æ ¼çœ‹èµ·æ¥ä¼šæ›´ç›´è§‚ä¸€äº›ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å¿«é€’ç³»ç»Ÿ</th>
<th style="text-align:center">Androidæ¶ˆæ¯ç³»ç»Ÿ</th>
<th style="text-align:center">èŒè´£</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">å‘ä»¶äºº</td>
<td style="text-align:center">Handler</td>
<td style="text-align:center">å‘é€æ¶ˆæ¯</td>
</tr>
<tr>
<td style="text-align:center">æ”¶ä»¶äºº</td>
<td style="text-align:center">Handler</td>
<td style="text-align:center">æ¥æ”¶å¤„ç†æ¶ˆæ¯</td>
</tr>
<tr>
<td style="text-align:center">å¿«ä»¶</td>
<td style="text-align:center">Message</td>
<td style="text-align:center">å‘é€çš„å†…å®¹</td>
</tr>
<tr>
<td style="text-align:center">å¿«é€’å…¬å¸</td>
<td style="text-align:center">Looper / MessageQueue</td>
<td style="text-align:center">æ¥æ”¶æ¶ˆæ¯ã€ä¼ é€’æ¶ˆæ¯ã€åˆ†å‘æ¶ˆæ¯</td>
</tr>
</tbody>
</table>
<p>ç›¸ä¿¡è¿™ä¸ªç®€å•çš„å¯¹æ¯”å¯¹ç†è§£æ¶ˆæ¯æœºåˆ¶ä¼šæœ‰å¾ˆå¤§å¸®åŠ©ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ªç³»ç»Ÿæ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚</p>
<p>å…ˆçœ‹ä¸€ä¸‹æ¶ˆæ¯ç³»ç»Ÿçš„ç®€å•ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Handler mHandler = <span class="keyword">new</span> Handler() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.handleMessage(msg);</div><div class="line"></div><div class="line">            printMsg(<span class="string">"handleMessage:"</span> + msg.obj);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (view.getId()) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.btSendMsg:</div><div class="line">                defaultSendMsg();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">defaultSendMsg</span><span class="params">()</span> </span>&#123;</div><div class="line">        Message msg = <span class="keyword">new</span> Message();</div><div class="line">        msg.obj = <span class="string">"è¿™æ˜¯æœ€ç®€å•çš„ä½¿ç”¨æ–¹æ³•ï¼Œä½†æ— å®é™…æ„ä¹‰"</span>;</div><div class="line">        mHandler.sendMessage(msg);</div><div class="line">        printMsg(<span class="string">"Is MainLooper: "</span> + (mHandler.getLooper() == getMainLooper()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printMsg</span><span class="params">(String msg)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;"</span> + msg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">I/System.out: &gt;&gt;&gt;&gt;&gt;Is MainLooper: true</div><div class="line">I/System.out: &gt;&gt;&gt;&gt;&gt;handleMessage:è¿™æ˜¯æœ€ç®€å•çš„ä½¿ç”¨æ–¹æ³•ï¼Œä½†æ— å®é™…æ„ä¹‰</div></pre></td></tr></table></figure>
<p>ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªHandlerå¯¹è±¡ï¼Œç„¶åé€šè¿‡è¿™ä¸ªHandlerå‘é€æ¶ˆæ¯ï¼Œç„¶ååœ¨Handlerä¸­å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚å¦å¤–æˆ‘ä»¬è¿˜çœ‹åˆ°æˆ‘ä»¬çš„Looperå¯¹è±¡æ˜¯ä¸»çº¿ç¨‹çš„Looperï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯åœ¨Activityè·‘çš„è¿™æ®µä»£ç ã€‚ä¸‹é¢æˆ‘ä»¬æ¥è·Ÿä¸€ä¸‹ä»£ç ã€‚</p>
<p>ä»Handlerçš„æ„é€ æ–¹æ³•å¼€å§‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">   ...</div><div class="line"></div><div class="line">   mLooper = Looper.myLooper();</div><div class="line">   <span class="keyword">if</span> (mLooper == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">           <span class="string">"Can't create handler inside thread that has not called Looper.prepare()"</span>);</div><div class="line">   &#125;</div><div class="line">   mQueue = mLooper.mQueue;</div><div class="line">   mCallback = callback; <span class="comment">// è¿™ä¸ªå¯¹è±¡æˆ‘ä»¬åœ¨åé¢çš„dispatchMessageæ—¶ä¼šç”¨åˆ°</span></div><div class="line">   mAsynchronous = async;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œé€šè¿‡ <code>Looper.myLooper()</code> è·å–åˆ°ä¸€ä¸ªLooperå¯¹è±¡ï¼Œç„¶åå†ä»è¿™ä¸ªLooperå¯¹è±¡ä¸­æ‹¿åˆ°ä¸€ä¸ªMessageQueueå¯¹è±¡ï¼ˆmQueueï¼‰ï¼Œè¿™æ ·æˆ‘ä»¬å¾ˆå®¹æ˜“å¾—åˆ°ç»“è®ºâ€”â€”æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä½äºLooperä¸­çš„ã€‚é‚£MessageQueueæ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Œåˆæ˜¯æ€æ ·å¤„ç†æ¶ˆæ¯çš„ï¼Ÿå¸¦ç€è¿™äº›ç–‘é—®æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ <code>Handler.sendMessage(msg)</code> (<code>sendMessage()</code> æœ€ç»ˆä¼šè°ƒåˆ° <code>sendMessageAtTime()</code>)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">   MessageQueue queue = mQueue;</div><div class="line">   <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</div><div class="line">       RuntimeException e = <span class="keyword">new</span> RuntimeException(</div><div class="line">               <span class="keyword">this</span> + <span class="string">" sendMessageAtTime() called with no mQueue"</span>);</div><div class="line">       Log.w(<span class="string">"Looper"</span>, e.getMessage(), e);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">   msg.target = <span class="keyword">this</span>;</div><div class="line">   <span class="keyword">if</span> (mAsynchronous) &#123;</div><div class="line">       msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>sendMessageAtTime()</code> ä¼šä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼š<code>Message</code> å’Œ <code>uptimeMillis</code>ï¼Œ<code>uptimeMillis</code> çš„æ„æ€æ˜¯æ¶ˆæ¯å°†ä¼šåœ¨è¿™ä¸ªæ—¶åˆ»æ‰§è¡Œï¼ˆä¸æ˜¯éå¸¸ç²¾ç¡®ï¼‰ï¼Œè¿™ç§æƒ…å†µæ¯”å¦‚å¸¸è§çš„ <code>postDelay</code>ã€‚åœ¨ <code>enqueueMessage()</code> æ–¹æ³•ä¸­ï¼Œä¼šæ ¹æ®è¿™ä¸ªå€¼å°†æ¶ˆæ¯åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ”¾å…¥é˜Ÿåˆ—ä¹‹å‰Messageçš„ <code>target</code> è¢«è®¾ç½®ä¸ºå½“å‰çš„Handlerå¯¹è±¡â€”â€”é€éœ²ä¸‹è¿™ä¸ªæ˜¯ä¿è¯ä¹‹åæ¶ˆæ¯æŠ•é€’çš„æ—¶å€™ä»åˆ†å‘ç»™å½“å‰Handlerï¼Œè¿™ä¸ªå¾ˆé‡è¦ï¼</p>
<p>å†æ¥çœ‹ä¸‹ä¸Šé¢æåˆ°çš„ Looper å’Œ MessageQueueï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Looper</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// sThreadLocal.get() will return null unless you've called prepare().</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;Looper&gt;();</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</div><div class="line">       &#125;</div><div class="line">       sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">    * Initialize the current thread as a looper, marking it as an</div><div class="line">    * application's main looper. The main looper for your application</div><div class="line">    * is created by the Android environment, so you should never need</div><div class="line">    * to call this function yourself.  See also: &#123;<span class="doctag">@link</span> #prepare()&#125;</div><div class="line">    */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepareMainLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">       prepare(<span class="keyword">false</span>);</div><div class="line">       <span class="keyword">synchronized</span> (Looper.class) &#123;</div><div class="line">           <span class="keyword">if</span> (sMainLooper != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The main Looper has already been prepared."</span>);</div><div class="line">           &#125;</div><div class="line">           sMainLooper = myLooper();</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">    * Returns the application's main looper, which lives in the main thread of the application.</div><div class="line">    */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Looper <span class="title">getMainLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">synchronized</span> (Looper.class) &#123;</div><div class="line">           <span class="keyword">return</span> sMainLooper;</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">    * Run the message queue in this thread. Be sure to call</div><div class="line">    * &#123;<span class="doctag">@link</span> #quit()&#125; to end the loop.</div><div class="line">    */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> Looper me = myLooper();</div><div class="line">       <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">final</span> MessageQueue queue = me.mQueue;</div><div class="line">       ...</div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           Message msg = queue.next(); <span class="comment">// might block</span></div><div class="line">           <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">// No message indicates that the message queue is quitting.</span></div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">    </div><div class="line">           ...</div><div class="line">    </div><div class="line">           msg.target.dispatchMessage(msg);</div><div class="line">    </div><div class="line">           <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">               logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</div><div class="line">           &#125;</div><div class="line">    </div><div class="line">           ...</div><div class="line">    </div><div class="line">           msg.recycleUnchecked();</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">        mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);</div><div class="line">        mThread = Thread.currentThread();</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">    <span class="comment">/**</span></div><div class="line">    * Return the Looper object associated with the current thread.  Returns</div><div class="line">    * null if the calling thread is not associated with a Looper.</div><div class="line">    */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> sThreadLocal.get();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">    * Return the &#123;<span class="doctag">@link</span> MessageQueue&#125; object associated with the current</div><div class="line">    * thread.  This must be called from a thread running a Looper, or a</div><div class="line">    * NullPointerException will be thrown.</div><div class="line">    */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@NonNull</span> <span class="function">MessageQueue <span class="title">myQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> myLooper().mQueue;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">       mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);</div><div class="line">       mThread = Thread.currentThread();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Looperçš„æ„é€ æ–¹æ³•ä¸­åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ª MessageQueue å¯¹è±¡ï¼ŒåŒæ—¶è¿™ä¸ªæ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œå› æ­¤è¿™ä¸ªç±»æ— æ³•åœ¨å¤–éƒ¨é€šè¿‡newæ¥åˆ›å»ºï¼Œã€‚æˆ‘ä»¬çœ‹åˆ°å”¯ä¸€åˆ›å»ºçš„åœ°æ–¹å°±æ˜¯ <code>Looper.prepare()</code> æ–¹æ³•ä¸­ï¼Œåˆ›å»ºå¥½ä¹‹åç›´æ¥è¢«åŠ å…¥åˆ°ThreadLocalä¸­ã€‚å†æ¥çœ‹æˆ‘ä»¬åˆšæ‰ç”¨åˆ°çš„ <code>Looper.myLooper()</code> æ–¹æ³•ï¼Œè¿™å…¶ä¸­åªæœ‰ä¸€è¡Œå¾ˆå°´å°¬çš„ä»£ç ï¼Œ<code>sThreadLocal.get()</code> ï¼Œå®ƒå°±æ˜¯ä»ThreadLocalä¸­è·å– <code>å±äºå½“å‰çº¿ç¨‹çš„ Looper å¯¹è±¡</code>ã€‚å…³äº ThreadLocalï¼Œè¿™ä¸ªåœ¨æˆ‘çš„<a href="http://blog.csdn.net/ttdevs/article/details/71375416" target="_blank" rel="external">å¦ä¸€ç¯‡æ–‡ç« ä¸­æœ‰ä»‹ç»</a>â€”â€”æˆ‘ä»¬åœ¨çº¿ç¨‹ä¸­åˆ›å»ºçš„å˜é‡ï¼Œä»»ä½•ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®å¹¶å¯¹å…¶ä¿®æ”¹ï¼Œä½†æ˜¯æˆ‘ä»¬é€šè¿‡LocalThreadåˆ›å»ºçš„å˜é‡ï¼Œå°±åªæœ‰å½“å‰çº¿ç¨‹å¯ä»¥è®¿é—®äº†ã€‚</p>
<p>ä¹‹å‰æˆ‘ä»¬çŸ¥é“é€šè¿‡ Handler.sendMessage(msg) å°† Message å­˜å…¥ MessageQueue ä¸­ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒLooper.loop()ä¸­å¼€äº†ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå°†æ¶ˆæ¯ä» MessageQueue ä¸­å–å‡ºç„¶åè¿›è¡Œåˆ†å‘ã€‚çœ‹åˆ° MessageQueue åæˆ‘ç¬¬ä¸€ä¸ªæƒ³åˆ°å°±æ˜¯é˜»å¡é˜Ÿåˆ—ï¼Œç»“æœçœ‹äº†æºç ä¹‹åå¹¶ä¸æ˜¯è¿™ä¹ˆç®€å•ã€‚å¦‚æœæƒ³çœ‹è¿™ä¸ªç±»çš„åˆ†æï¼Œå¯ä»¥å‚è€ƒ<a href="http://blog.csdn.net/luoshengyang/article/details/6817933/" target="_blank" rel="external">è¿™é‡Œ</a>ï¼Œè¿™æ˜¯æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œæ¶‰åŠåˆ°æ“ä½œç³»ç»Ÿçš„çŸ¥è¯†ï¼Œæˆ‘å°±ä¸å–å¼„äº†ã€‚ä½†æ˜¯è¿™ä¸å½±å“æˆ‘ä»¬å°† MessageQueue æŒ‰ç…§ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—æ¥ç†è§£ã€‚</p>
<p>å†çœ‹ä¸‹Looperæ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚æˆ‘ä»¬åœ¨Looperçš„ç±»æ³¨é‡Šä¸­å¯ä»¥çœ‹åˆ°è¿™æ®µä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Class used to run a message loop for a thread.  Threads by default do</div><div class="line">  * not have a message loop associated with them; to create one, call</div><div class="line">  * &#123;<span class="doctag">@link</span> #prepare&#125; in the thread that is to run the loop, and then</div><div class="line">  * &#123;<span class="doctag">@link</span> #loop&#125; to have it process messages until the loop is stopped.</div><div class="line">  *</div><div class="line">  * &lt;p&gt;Most interaction with a message loop is through the</div><div class="line">  * &#123;<span class="doctag">@link</span> Handler&#125; class.</div><div class="line">  *</div><div class="line">  * &lt;p&gt;This is a typical example of the implementation of a Looper thread,</div><div class="line">  * using the separation of &#123;<span class="doctag">@link</span> #prepare&#125; and &#123;<span class="doctag">@link</span> #loop&#125; to create an</div><div class="line">  * initial Handler to communicate with the Looper.</div><div class="line">  *</div><div class="line">  * &lt;pre&gt;</div><div class="line">  *  class LooperThread extends Thread &#123;</div><div class="line">  *      public Handler mHandler;</div><div class="line">  *</div><div class="line">  *      public void run() &#123;</div><div class="line">  *          Looper.prepare();</div><div class="line">  *</div><div class="line">  *          mHandler = new Handler() &#123;</div><div class="line">  *              public void handleMessage(Message msg) &#123;</div><div class="line">  *                  // process incoming messages here</div><div class="line">  *              &#125;</div><div class="line">  *          &#125;;</div><div class="line">  *</div><div class="line">  *          Looper.loop();</div><div class="line">  *      &#125;</div><div class="line">  *  &#125;&lt;/pre&gt;</div><div class="line">  */</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Looper</span> </span>&#123;...&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨è‡ªå·±çš„çº¿ç¨‹ä¸­å®ç°æ¶ˆæ¯æœºåˆ¶ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ‰§è¡Œ <code>Looper.prepare();</code>ï¼› ç„¶ååˆ›å»º Handlerå¯¹è±¡ï¼›æœ€åå†æ‰§è¡Œ <code>Looper.loop()</code>ï¼›è¿™ä¸ªé¡ºåºä¸èƒ½é¢ å€’ï¼æœ€åæˆ‘ä»¬å†æ¥å°†è¿™ä¸ªæµç¨‹æ¢³ç†ä¸€ä¸‹ï¼š</p>
<ol>
<li><p>Looper.prepare()ï¼›</p>
<p> åˆå§‹åŒ–å±äºå½“å‰çº¿ç¨‹çš„ Looper å¯¹è±¡ï¼Œç„¶åæ”¾å…¥ ThreadLocal ä¸­ã€‚</p>
</li>
<li><p>new Handler()ï¼›</p>
<p> ä¸ºä»€ä¹ˆä¸€å®šè¦åœ¨ <code>Looper.prepare()</code> ä¹‹å <code>Looper.loop()</code> ä¹‹å‰åˆ›å»ºHandlerå¯¹è±¡å‘¢ï¼Ÿ </p>
<p> ç­”ï¼šåœ¨ <code>Looper.prepare()</code> ä¹‹åæ˜¯å› ä¸º Handler çš„æ„é€ å‡½æ•°ä¸­éœ€è¦æä¾›å½“å‰çº¿ç¨‹çš„ Looper å¯¹ è±¡ï¼Œè¿™ä¸ª Looper å¯¹è±¡åªèƒ½é€šè¿‡ <code>Looper.prepare()</code> æ¥åˆ›å»ºã€‚åœ¨ <code>Looper.loop()</code> ä¹‹å‰æ˜¯å› ä¸ºLooper.loop()æ˜¯ä¸ªæ­»å¾ªç¯ï¼Œå†™åœ¨å…¶åä»£ç æ˜¯æ‰§è¡Œä¸åˆ°çš„ï¼ˆçœ‹çœ‹æœ€åç•™çš„é‚£ä¸ªé—®é¢˜ï½ï¼‰ã€‚</p>
</li>
<li><p>Looper.loop();</p>
<p> è¿™ä¸ªæ“ä½œå°±æ˜¯å¼€å§‹æ‰§è¡Œæ¶ˆæ¯å¾ªç¯ï¼Œå¤„ç†æ¶ˆæ¯ã€‚</p>
</li>
</ol>
<p>å°ç»“ï¼š</p>
<p>æ¶ˆæ¯æœºåˆ¶æ˜¯Androidç³»ç»Ÿä¸­çº¿ç¨‹é€šä¿¡éå¸¸é‡è¦çš„ä¸€ç§æ–¹æ³•ã€‚å¦‚æœå‘å¦ä¸€ä¸ªçº¿ç¨‹ä¼ é€’æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç›®æ ‡çº¿ç¨‹ä¸­å¯åŠ¨æ¶ˆæ¯æœºåˆ¶ï¼Œæ‹¿åˆ°è¿™ä¸ªçº¿ç¨‹Looperå¯¹è±¡åˆ›å»ºä¸€ä¸ªHandlerï¼Œé€šè¿‡è¿™ä¸ªHandlerå°±å¯ä»¥å‘ç›®æ ‡çº¿ç¨‹å‘é€æ¶ˆæ¯äº†ï¼Œåä¹‹äº¦ç„¶ã€‚</p>
<h2 id="0x03-HandlerThreadã€AsyncTask-å’Œ-UI-Thread"><a href="/2017/07/26/Android-ä»é€šè¿‡view-post-è·å–Viewå®½é«˜è°ˆAndroidæ¶ˆæ¯æœºåˆ¶/#0x03-HandlerThreadã€AsyncTask-å’Œ-UI-Thread" class="headerlink" title="0x03 HandlerThreadã€AsyncTask å’Œ UI Thread"></a>0x03 HandlerThreadã€AsyncTask å’Œ UI Thread</h2><ul>
<li><p>HandlerThread</p>
<p>  ä»æºç å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªç±»æ˜¯å¯¹æˆ‘ä»¬Androidæ¶ˆæ¯æœºåˆ¶çš„ä¸€ä¸ªå°è£…ã€‚å½“æˆ‘ä»¬éœ€è¦è‡ªå·±å»å†™ä¸€ä¸ªåœ¨å­çº¿ç¨‹å·¥ä½œç„¶åå°†ç»“æœä¼ åˆ°ä¸»çº¿ç¨‹çš„åŠŸèƒ½æ—¶å¯ä»¥è€ƒè™‘ç”¨è¿™ä¸ªç±»ã€‚ä¸‹é¢æä¾›ä¸€ä¸ªç®€å•çš„Demoï¼š</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerThreadActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Handler mHandler = <span class="keyword">new</span> Handler()&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.handleMessage(msg);</div><div class="line"></div><div class="line">            String threadName = Thread.currentThread().getName();</div><div class="line">            tvLog.setText(String.format(<span class="string">"å½“å‰çº¿ç¨‹ï¼š%s Msgï¼š%s"</span>, threadName, msg.obj));</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TextView tvLog;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_handler_thread);</div><div class="line">        Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);</div><div class="line">        setSupportActionBar(toolbar);</div><div class="line"></div><div class="line">        tvLog = (TextView)findViewById(R.id.tvLog);</div><div class="line"></div><div class="line">        FloatingActionButton fab = (FloatingActionButton) findViewById(R.id.fab);</div><div class="line">        fab.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">                sendMessage();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        initData();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Handler mWorker;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</div><div class="line">        HandlerThread worker = <span class="keyword">new</span> HandlerThread(<span class="string">"worker"</span>);</div><div class="line">        worker.start();</div><div class="line">        mWorker = <span class="keyword">new</span> Handler(worker.getLooper());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">()</span> </span>&#123;</div><div class="line">        mWorker.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                print(<span class="string">"æˆ‘å·¥ä½œåœ¨çº¿ç¨‹ï¼š"</span> + Thread.currentThread().getName());</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">6</span> * <span class="number">1000</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                sendMsgToUI();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMsgToUI</span><span class="params">()</span></span>&#123;</div><div class="line">                Message msg = <span class="keyword">new</span> Message();</div><div class="line">                msg.obj = Thread.currentThread().getName() + <span class="string">"å·¥ä½œå®Œæˆï¼Œè¿™æ˜¯ç»“æœ"</span>;</div><div class="line">                    mHandler.sendMessage(msg);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String msg)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;"</span> + msg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ€è·¯å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»ºHandlerThreadå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ªçº¿ç¨‹</li>
<li>å¯åŠ¨ç¬¬ä¸€æ­¥åˆ›å»ºçš„çº¿ç¨‹</li>
<li>åˆ›å»ºä¸€ä¸ªHandlerï¼Œå¹¶ä½¿ç”¨ç¬¬ä¸€æ­¥åˆ›å»ºçš„çº¿ç¨‹ä¸­çš„Looper</li>
<li>ç„¶ååœ¨ä¸»çº¿ç¨‹é€šè¿‡è¿™ä¸ªHandlerå‘å·¥ä½œçº¿ç¨‹å‘ä»»åŠ¡</li>
<li>ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œä½¿ç”¨åœ¨Activityï¼ˆä¸»çº¿ç¨‹ï¼‰ä¸­çš„Handlerå‘é€æ¶ˆæ¯ï¼Œå°†ç»“æœä»å·¥ä½œçº¿ç¨‹ä¼ å›ä¸»çº¿ç¨‹</li>
</ol>
<ul>
<li><p>AsyncTask</p>
<p>  è¿™æ˜¯ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…·ç±»ï¼Œç”¨åˆ°çš„çŸ¥è¯†ç‚¹ä¹Ÿéå¸¸å¤šï¼Œæ›¾ç»ç»Ÿæ²»è¿‡ç½‘ç»œåº“çš„ç¼–å†™ã€‚è¿™é‡Œåªè®²è·Ÿæˆ‘ä»¬æ¶ˆæ¯ç³»ç»Ÿç›¸å…³çš„çŸ¥è¯†ï¼Œå…ˆçœ‹ä¸€æ®µæºç ï¼š</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTask</span>&lt;<span class="title">Params</span>, <span class="title">Progress</span>, <span class="title">Result</span>&gt; </span>&#123;</div><div class="line">...</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> InternalHandler sHandler; </div><div class="line">...</div><div class="line">    <span class="comment">// è·å–åˆ°Handler</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Handler <span class="title">getHandler</span><span class="params">()</span> </span>&#123; </div><div class="line">        <span class="keyword">synchronized</span> (AsyncTask.class) &#123;</div><div class="line">            <span class="keyword">if</span> (sHandler == <span class="keyword">null</span>) &#123;</div><div class="line">                sHandler = <span class="keyword">new</span> InternalHandler();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> sHandler;</div><div class="line">        &#125;</div><div class="line">...</div><div class="line">    <span class="comment">// åœ¨å·¥ä½œçº¿ç¨‹å‘é€ç»“æœåˆ°ä¸»çº¿ç¨‹ï¼Œè¿™é‡Œè·å–åˆ°Message.targetéƒ½æ˜¯sHandlerå¯¹è±¡</span></div><div class="line">    <span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">        Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</div><div class="line">                <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));</div><div class="line">        message.sendToTarget();</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">...</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &lt;p&gt;Runs on the UI thread after &#123;<span class="doctag">@link</span> #doInBackground&#125;. The</div><div class="line">     * specified result is the value returned by &#123;<span class="doctag">@link</span> #doInBackground&#125;.&lt;/p&gt;</div><div class="line">     * </div><div class="line">     * &lt;p&gt;This method won't be invoked if the task was cancelled.&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> result The result of the operation computed by &#123;<span class="doctag">@link</span> #doInBackground&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #onPreExecute</div><div class="line">     * <span class="doctag">@see</span> #doInBackground</div><div class="line">     * <span class="doctag">@see</span> #onCancelled(Object) </div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"UnusedDeclaration"</span>&#125;)</div><div class="line">    <span class="meta">@MainThread</span> <span class="comment">// è¿™ä¸ªæ–¹æ³•é‡Œçš„ä»£ç éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œäº†</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Runs on the UI thread after &#123;<span class="doctag">@link</span> #publishProgress&#125; is invoked.</div><div class="line">     * The specified values are the values passed to &#123;<span class="doctag">@link</span> #publishProgress&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> values The values indicating progress.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #publishProgress</div><div class="line">     * <span class="doctag">@see</span> #doInBackground</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"UnusedDeclaration"</span>&#125;)</div><div class="line">    <span class="meta">@MainThread</span> <span class="comment">// è¿™ä¸ªæ–¹æ³•é‡Œçš„ä»£ç éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œäº†</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onProgressUpdate</span><span class="params">(Progress... values)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">...</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This method can be invoked from &#123;<span class="doctag">@link</span> #doInBackground&#125; to</div><div class="line">     * publish updates on the UI thread while the background computation is</div><div class="line">     * still running. Each call to this method will trigger the execution of</div><div class="line">     * &#123;<span class="doctag">@link</span> #onProgressUpdate&#125; on the UI thread.</div><div class="line">     *</div><div class="line">     * &#123;<span class="doctag">@link</span> #onProgressUpdate&#125; will not be called if the task has been</div><div class="line">     * canceled.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> values The progress values to update the UI with.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #onProgressUpdate</div><div class="line">     * <span class="doctag">@see</span> #doInBackground</div><div class="line">     */</div><div class="line">    <span class="meta">@WorkerThread</span> <span class="comment">// ä»å·¥ä½œçº¿ç¨‹å‘æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishProgress</span><span class="params">(Progress... values)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isCancelled()) &#123;</div><div class="line">            getHandler().obtainMessage(MESSAGE_POST_PROGRESS,</div><div class="line">                    <span class="keyword">new</span> AsyncTaskResult&lt;Progress&gt;(<span class="keyword">this</span>, values)).sendToTarget();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isCancelled()) &#123;</div><div class="line">            onCancelled(result);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            onPostExecute(result);</div><div class="line">        &#125;</div><div class="line">        mStatus = Status.FINISHED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(Looper.getMainLooper()); <span class="comment">// åˆ›å»ºä¸€ä¸ªHandlerå¯¹è±¡ï¼Œä½¿ç”¨çš„Looperæ˜¯ä¸»çº¿ç¨‹çš„Looperï¼Œé‚£ä¹ˆå®ƒå¤„ç†çš„æ¶ˆæ¯éƒ½å°†åœ¨ä¸»çº¿ç¨‹ï¼Œè¿™ä¸ªå¾ˆå…³é”®</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> MESSAGE_POST_RESULT:</div><div class="line">                    <span class="comment">// There is only one result</span></div><div class="line">                    result.mTask.finish(result.mData[<span class="number">0</span>]);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</div><div class="line">                    result.mTask.onProgressUpdate(result.mData);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹äº†ä¸Šé¢çš„æºç å†å›æƒ³ä¸‹AsyncTaskç”¨æ³•æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“è®ºï¼š</p>
<ol>
<li>ä¸»çº¿ç¨‹æ— éœ€åŠ¨æ€å‘å·¥ä½œçº¿ç¨‹å‘æ¶ˆæ¯ï¼Œåªæ˜¯åˆå§‹åŒ–çš„æ—¶å€™ä¼ é€’ä¸€äº›å‚æ•°</li>
<li>å·¥ä½œçº¿ç¨‹å®Œæˆåï¼Œé€šè¿‡è·å–ä¸»çº¿ç¨‹çš„Looperï¼Œæ„å»ºHandlerå°†ç»“æœå‘é€ç»™ä¸»çº¿ç¨‹</li>
</ol>
<ul>
<li><p>UI Thread</p>
<p>  çœ‹äº†ä¸Šé¢çš„ä¸¤ä¸ªæ¡ˆä¾‹ï¼Œæˆ‘ä»¬åœ¨æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨çš„ä¸»çº¿ç¨‹å¯ä»¥ç›´æ¥ä½¿ç”¨æ¶ˆæ¯ç³»ç»Ÿè€Œæ²¡æœ‰æ‰§è¡Œ<code>Looper.prepare()</code>ï¼Œ<code>Looper.loop()</code> ä¹‹ç±»çš„åˆå§‹åŒ–å·¥ä½œå‘¢ã€‚</p>
<p>  å…¶å®ç»“è®ºå¾ˆç®€å•ï¼Œä¸å¯èƒ½ä¸åˆå§‹åŒ–ï¼Œåªæ˜¯ç³»ç»Ÿæå‰å·²ç»å¸®æˆ‘ä»¬åˆå§‹åŒ–å¥½äº†ï¼Œè¿™éƒ¨åˆ†çš„æºç ä½äº <code>sdk/sources/android-xx/android/app/ActivityThread.java</code> ä¸­ï¼š</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</div><div class="line">...</div><div class="line">    <span class="keyword">final</span> H mH = <span class="keyword">new</span> H();</div><div class="line">...</div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LAUNCH_ACTIVITY         = <span class="number">100</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PAUSE_ACTIVITY          = <span class="number">101</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PAUSE_ACTIVITY_FINISHING= <span class="number">102</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP_ACTIVITY_SHOW      = <span class="number">103</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP_ACTIVITY_HIDE      = <span class="number">104</span>;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">      ...</div><div class="line">      <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">          <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</div><div class="line">              Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</div><div class="line">              <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</div><div class="line">              r.packageInfo = getPackageInfoNoCheck(</div><div class="line">                      r.activityInfo.applicationInfo, r.compatInfo);</div><div class="line">              handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</div><div class="line">              Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">          &#125; <span class="keyword">break</span>;</div><div class="line">          <span class="keyword">case</span> RELAUNCH_ACTIVITY: &#123;</div><div class="line">              Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityRestart"</span>);</div><div class="line">              ActivityClientRecord r = (ActivityClientRecord)msg.obj;</div><div class="line">              handleRelaunchActivity(r);</div><div class="line">              Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">          &#125; <span class="keyword">break</span>;</div><div class="line">          <span class="keyword">case</span> PAUSE_ACTIVITY: &#123;</div><div class="line">              Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityPause"</span>);</div><div class="line">              SomeArgs args = (SomeArgs) msg.obj;</div><div class="line">              handlePauseActivity((IBinder) args.arg1, <span class="keyword">false</span>,</div><div class="line">                      (args.argi1 &amp; USER_LEAVING) != <span class="number">0</span>, args.argi2,</div><div class="line">                      (args.argi1 &amp; DONT_REPORT) != <span class="number">0</span>, args.argi3);</div><div class="line">              maybeSnapshot();</div><div class="line">              Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">          &#125; <span class="keyword">break</span>;</div><div class="line">          ...</div><div class="line">       &#125;</div><div class="line">       ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"ActivityThreadMain"</span>);</div><div class="line">        SamplingProfilerIntegration.start();</div><div class="line"></div><div class="line">        <span class="comment">// CloseGuard defaults to true and can be quite spammy.  We</span></div><div class="line">        <span class="comment">// disable it here, but selectively enable it later (via</span></div><div class="line">        <span class="comment">// StrictMode) on debug builds, but using DropBox, not logs.</span></div><div class="line">        CloseGuard.setEnabled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        Environment.initForCurrentUser();</div><div class="line"></div><div class="line">        <span class="comment">// Set the reporter for event logging in libcore</span></div><div class="line">        EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</div><div class="line"></div><div class="line">        <span class="comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span></div><div class="line">        <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</div><div class="line">        TrustedCertificateStore.setDefaultUserDirectory(configDir);</div><div class="line"></div><div class="line">        Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</div><div class="line"></div><div class="line">        Looper.prepareMainLooper(); <span class="comment">// å‡†å¤‡MainLooper</span></div><div class="line"></div><div class="line">        ActivityThread thread = <span class="keyword">new</span> ActivityThread();</div><div class="line">        thread.attach(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</div><div class="line">            sMainThreadHandler = thread.getHandler();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">            Looper.myLooper().setMessageLogging(<span class="keyword">new</span></div><div class="line">                    LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// End of event ActivityThreadMain.</span></div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">        Looper.loop(); <span class="comment">// å¯åŠ¨è¿™ä¸ªæ¶ˆæ¯å¾ªç¯</span></div><div class="line"></div><div class="line">        <span class="comment">// å½“ä¸Šé¢çš„Looperæ‰§è¡Œquit()çš„æ—¶å€™æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå½“ç„¶ï¼Œè¿™ä¸ªæ—¶å€™appå°±è¦é€€å‡ºäº†</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å†å›åˆ°æˆ‘ä»¬æ–‡ç« å¼€å§‹çš„æ—¶å€™æåˆ°çš„é—®é¢˜ï¼šä¸ºä»€ä¹ˆé€šè¿‡ <code>view.post()</code> å¯ä»¥è·å–åˆ°Viewçš„å°ºå¯¸å‘¢ï¼Ÿ</p>
<p>ç­”ï¼šé¦–å…ˆå¤§å®¶éœ€è¦çŸ¥é“ï¼Œæˆ‘ä»¬Activityçš„å¯åŠ¨ï¼Œä¹Ÿæ˜¯é€šè¿‡ç³»ç»Ÿæ¶ˆæ¯çš„æ–¹å¼è§¦å‘çš„ã€‚ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“ <code>Looper.loop()</code> æ‰§è¡Œä¹‹åï¼Œå³å¯æ¥æ”¶ç³»ç»Ÿæ¶ˆæ¯äº†ï¼Œæ¯”å¦‚å¯åŠ¨Activityä¹‹ç±»çš„æ¶ˆæ¯ã€‚å½“ç³»ç»Ÿå‘å‡ºäº†ä¸€ä¸ªå¯åŠ¨Activityçš„æ¶ˆæ¯ï¼Œç„¶åæ‰§è¡Œè¿™ä¸ªæ¶ˆæ¯æ‰ä¼šå»å¯åŠ¨Actvityï¼Œå¯åŠ¨Activiyä¼šè°ƒç”¨å®ƒçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œæ¯”å¦‚ <code>onCreate()</code> ç­‰ï¼Œåœ¨ <code>Activity.onCreate()</code> ä¸­ç”¨view.postå‘ä¸€ä¸ªä»»åŠ¡åˆ°ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé‚£è¿™ä¸ªæ¶ˆæ¯è‚¯å®šè¦ç­‰ä¹‹å‰çš„æ¶ˆæ¯ä»»åŠ¡æ‰§è¡Œå®Œï¼Œä¹Ÿå°±æ˜¯å½“å‰åˆ›å»ºActivityçš„æ¶ˆæ¯æ‰§è¡Œå®Œæˆä¹‹åæ‰èƒ½æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°Viewçš„å°ºå¯¸äº†ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewPostActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> TextView tvInfo;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_view_post);</div><div class="line"></div><div class="line">        printMsg(<span class="string">"onCreate"</span>);</div><div class="line"></div><div class="line">        tvInfo = (TextView) findViewById(R.id.tvInfo);</div><div class="line">        tvInfo.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                printMsg(<span class="string">"Width:"</span> + tvInfo.getWidth());</div><div class="line">                printMsg(<span class="string">"Height:"</span> + tvInfo.getHeight());</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStart();</div><div class="line"></div><div class="line">        printMsg(<span class="string">"onStart"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onResume();</div><div class="line"></div><div class="line">        printMsg(<span class="string">"onResume"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printMsg</span><span class="params">(String msg)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;"</span> + msg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºçš„Logï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">07</span>-<span class="number">27</span> <span class="number">13</span>:<span class="number">06</span>:<span class="number">36.373</span> <span class="number">17506</span>-<span class="number">17506</span>/com.ttdevs.message I/System.out: &gt;&gt;&gt;&gt;&gt;onCreate</div><div class="line"><span class="number">07</span>-<span class="number">27</span> <span class="number">13</span>:<span class="number">06</span>:<span class="number">36.378</span> <span class="number">17506</span>-<span class="number">17506</span>/com.ttdevs.message I/System.out: &gt;&gt;&gt;&gt;&gt;onStart</div><div class="line"><span class="number">07</span>-<span class="number">27</span> <span class="number">13</span>:<span class="number">06</span>:<span class="number">36.378</span> <span class="number">17506</span>-<span class="number">17506</span>/com.ttdevs.message I/System.out: &gt;&gt;&gt;&gt;&gt;onResume</div><div class="line"><span class="number">07</span>-<span class="number">27</span> <span class="number">13</span>:<span class="number">06</span>:<span class="number">36.433</span> <span class="number">17506</span>-<span class="number">17506</span>/com.ttdevs.message I/System.out: &gt;&gt;&gt;&gt;&gt;Width:<span class="number">248</span></div><div class="line"><span class="number">07</span>-<span class="number">27</span> <span class="number">13</span>:<span class="number">06</span>:<span class="number">36.433</span> <span class="number">17506</span>-<span class="number">17506</span>/com.ttdevs.message I/System.out: &gt;&gt;&gt;&gt;&gt;Height:<span class="number">76</span></div></pre></td></tr></table></figure>
<p>å’Œæ¨æµ‹çš„ä¸€è‡´ï¼ŒCooooolï½ï½</p>
<p>æœ€åï¼Œç•™ä¸ªå¥½ç©çš„é—®é¢˜ï¼Œæ‰§è¡Œ <code>getMainLooper().quit()</code> ä¼šæ€æ ·å‘¢ï¼Ÿ</p>
<p><a href="https://github.com/ttdevs/android/tree/master/apps/message" target="_blank" rel="external">æºç å‚è€ƒè¿™é‡Œ</a></p>
<hr>
<p><img src="https://raw.githubusercontent.com/ttdevs/ttdevs.github.io/common/images/logo.png" alt="Create by ttdevs"></p>

          </section>
        </article>
        

       
        <div class="pager">
          
            <a class="post-prev pager-item" href="/2017/06/20/2017-06-20/" >
              <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
              <p class="post-nav-title"></p>
            </a>
          
          
        </div>
        

         <!-- comments -->
        <div class="comment-section">
  
    


</div>

    </div>
    
    <aside>
        <div id="toc">
        </div>
    </aside>
    
</div>

                </div>
            </div>
        </div>
        <footer class="footer">
    <p>ç”±<a href="http://hexo.io/" target="_blank">Hexo</a>å¼ºåŠ›é©±åŠ¨ï¼Œæ­è½½<a href="https://github.com/wayou/hexo-theme-gstyle">gstyle</a>ä¸»é¢˜</p>
    <p>
        &copy; 2017 ttdevs
    </p>
</footer>
<script src="/lib/jquery.js"></script>
<script src="/lib/waves.js"></script>
<script src="/lib/jquery-ui.js"></script>
<script src="/lib/jquery.tocify.js"></script>
<script src="/js/main.js"></script>

    </body>
</html>
